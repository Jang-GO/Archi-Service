<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>API 테스트</title>
</head>
<body>
<h1>JWT API 테스트</h1>

<div>
    <strong>로그인 사용자:</strong> <span id="currentUser"></span>
    <button onclick="logout()">로그아웃</button>
    <button onclick="refreshToken()">토큰 재발급</button>
</div>

<hr>

<h3>API 테스트</h3>
<button onclick="testPublicApi()">Public API</button>
<button onclick="testAuthenticatedApi()">인증 API</button>
<button onclick="testUserApi()">USER 권한 API</button>
<button onclick="testAdminApi()">ADMIN 권한 API</button>
<button onclick="testWithoutToken()">토큰없이 테스트</button>

<div id="result" style="margin-top: 20px; border: 1px solid #ccc; padding: 10px;"></div>

<script>
    window.onload = function() {
        const username = localStorage.getItem('username');
        if (!username) {
            alert('로그인이 필요합니다.');
            window.location.href = 'index.html';
            return;
        }
        document.getElementById('currentUser').textContent = username;
    };

    async function callApi(url, useToken = true) {
        const resultDiv = document.getElementById('result');

        try {
            const headers = { 'Content-Type': 'application/json' };

            if (useToken) {
                const token = localStorage.getItem('accessToken');
                if (token) headers['Authorization'] = 'Bearer ' + token;
            }

            const response = await fetch(url, { method: 'GET', headers });
            const data = await response.json();

            resultDiv.innerHTML = `<strong>Status:</strong> ${response.status}<br><strong>Response:</strong><br><pre>${JSON.stringify(data, null, 2)}</pre>`;

        } catch (error) {
            resultDiv.innerHTML = `<strong>Error:</strong> ${error.message}`;
        }
    }

    function testPublicApi() { callApi('/api/test/public', false); }
    function testAuthenticatedApi() { callApi('/api/test/authenticated'); }
    function testUserApi() { callApi('/api/test/user'); }
    function testAdminApi() { callApi('/api/test/admin'); }
    function testWithoutToken() { callApi('/api/test/user', false); }

    async function refreshToken() {
        try {
            const refreshTokenValue = localStorage.getItem('refreshToken');
            const response = await fetch('/api/auth/refresh', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + refreshTokenValue }
            });
            const data = await response.json();

            if (data.result === 'SUCCESS') {
                localStorage.setItem('accessToken', data.data.accessToken);
                alert('토큰 재발급 성공!');
            } else {
                alert('토큰 재발급 실패');
            }
        } catch (error) {
            alert('토큰 재발급 오류');
        }
    }

    async function logout() {
        try {
            const accessToken = localStorage.getItem('accessToken');
            await fetch('/api/auth/logout', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + accessToken }
            });
        } catch (error) {}

        localStorage.clear();
        window.location.href = 'index.html';
    }
</script>
</body>
</html>